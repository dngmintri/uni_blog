@page "/profile"
@using Blazorise
@using Blazorise.Icons.FontAwesome
@using Blazorise.Components
@using frontend.Services
@using frontend.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@using System.Net.Http
@using System.Text.Json
@inject IAuthService authService
@inject IUserService userService
@inject ITokenManagerService tokenManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navigationManager
@inject PageTitleService PageTitleService
@inject IUserUpdateService userUpdateService
@inject IPostService postService
@inject CommentService commentService

<link href="css/dashboard.css" rel="stylesheet" />

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="container-fluid">
        <!-- Back Button -->
        <div class="row mb-3">
            <div class="col-12">
                <Button Color="Color.Light" Size="Size.Small" @onclick="GoToDashboard" class="btn-outline-secondary">
                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.ArrowLeft" class="me-2" />
                    Quay l·∫°i
                </Button>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            @if (!string.IsNullOrEmpty(currentUser?.AvatarUrl))
                            {
                                <img src="@currentUser.AvatarUrl" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="rounded-circle d-flex align-items-center justify-content-center bg-light" style="width: 120px; height: 120px; margin: 0 auto;">
                                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.User" Size="IconSize.X3" Class="text-muted" />
                                </div>
                            }
                        </div>
                        <h5>@(currentUser?.FullName ?? "User")</h5>
                        <p class="text-muted">@(currentUser?.Username ?? "")</p>
                        <Button Color="Color.Primary" Size="Size.Small" @onclick="OpenAvatarModal">
                            <Blazorise.Icons.FontAwesome.Icon Name="IconName.Camera" /> ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán
                        </Button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="card mt-3">
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action @(activeTab == "info" ? "active" : "")" @onclick='() => SetActiveTab("info")'>
                            <Blazorise.Icons.FontAwesome.Icon Name="IconName.User" /> Th√¥ng tin c√° nh√¢n
                        </a>
                        <a class="list-group-item list-group-item-action @(activeTab == "security" ? "active" : "")" @onclick='() => SetActiveTab("security")'>
                            <Blazorise.Icons.FontAwesome.Icon Name="IconName.Lock" /> B·∫£o m·∫≠t
                        </a>
                        <a class="list-group-item list-group-item-action @(activeTab == "posts" ? "active" : "")" @onclick='() => SetActiveTab("posts")'>
                            <Blazorise.Icons.FontAwesome.Icon Name="IconName.File" /> B√†i vi·∫øt c·ªßa t√¥i
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                @if (activeTab == "info")
                {
                    <!-- Th√¥ng tin c√° nh√¢n -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Th√¥ng tin c√° nh√¢n</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">H·ªç v√† t√™n *</label>
                                        <TextEdit @bind-Text="userInfo.FullName" Placeholder="Nh·∫≠p h·ªç v√† t√™n" Class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email *</label>
                                        <TextEdit @bind-Text="userInfo.Email" Placeholder="Nh·∫≠p email" Class="form-control" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Ng√†y sinh</label>
                                        <DateEdit @bind-Date="userInfo.DateOfBirth" Placeholder="Ch·ªçn ng√†y sinh" Class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Gi·ªõi t√≠nh</label>
                                        <Select @bind-SelectedValue="userInfo.Gender" Placeholder="Ch·ªçn gi·ªõi t√≠nh" Class="form-control">
                                            <SelectItem TValue="string" Value="@("Nam")">Nam</SelectItem>
                                            <SelectItem TValue="string" Value="@("N·ªØ")">N·ªØ</SelectItem>
                                            <SelectItem TValue="string" Value="@("Kh√°c")">Kh√°c</SelectItem>
                                        </Select>
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(message))
                            {
                                <Alert Color="@(isSuccess ? Color.Success : Color.Danger)" Visible="true" class="mt-3">
                                    @message
                                </Alert>
                            }

                            <div class="d-flex justify-content-end mt-4">
                                <Button Color="Color.Secondary" @onclick="ResetForm" class="me-2">H·ªßy</Button>
                                <Button Color="Color.Primary" @onclick="SaveProfile" Disabled="isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    }
                                    L∆∞u thay ƒë·ªïi
                                </Button>
                            </div>
                        </div>
                    </div>
                }
                else if (activeTab == "security")
                {
                    <!-- B·∫£o m·∫≠t -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Thay ƒë·ªïi m·∫≠t kh·∫©u</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
                                <input type="password" @bind="passwordChange.CurrentPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M·∫≠t kh·∫©u m·ªõi *</label>
                                <input type="password" @bind="passwordChange.NewPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
                                <input type="password" @bind="passwordChange.ConfirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" class="form-control" />
                            </div>

                            @if (!string.IsNullOrEmpty(passwordMessage))
                            {
                                <Alert Color="@(isPasswordSuccess ? Color.Success : Color.Danger)" Visible="true" class="mt-3">
                                    @passwordMessage
                                </Alert>
                            }

                            <div class="d-flex justify-content-end mt-4">
                                <Button Color="Color.Primary" @onclick="ChangePassword" Disabled="isChangingPassword">
                                    @if (isChangingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    }
                                    ƒê·ªïi m·∫≠t kh·∫©u
                                </Button>
                            </div>
                        </div>
                    </div>
                }
                else if (activeTab == "posts")
                {
                    <!-- B√†i vi·∫øt c·ªßa t√¥i -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">B√†i vi·∫øt c·ªßa t√¥i</h5>
                        </div>
                        <div class="card-body">
                            @if (isLoadingPosts)
                            {
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            }
                            else if (userPosts == null || !userPosts.Any())
                            {
                                <div class="text-center text-muted py-5">
                                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.File" Size="IconSize.X3" />
                                    <p class="mt-3">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
                                    <Button Color="Color.Primary" @onclick="GoToDashboard">Vi·∫øt b√†i m·ªõi</Button>
                                </div>
                            }
                            else
                            {
                                @foreach (var post in userPosts)
                                {
                                    <div class="post-item mb-3" style="cursor: pointer;" @onclick="() => OpenPostModal(post)">
                                        <div class="d-flex align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 fw-bold">@post.Title</h6>
                                                <small class="text-muted">
                                                    <i class="far fa-calendar"></i> @post.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <div class="post-content mb-2">
                                            <p style="white-space: pre-line; line-height: 1.4; color: #555; margin-bottom: 0;">
                                                @(post.Content.Length > 150 ? post.Content.Substring(0, 150) + "..." : post.Content)
                                            </p>
                                        </div>

                                        @if (!string.IsNullOrEmpty(post.ImageUrl))
                                        {
                                            <div class="post-media mb-2">
                                                <img src="@post.ImageUrl" class="rounded" style="width: 100%; max-height: 180px; object-fit: cover;" />
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Modal ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán -->
    <Modal @ref="avatarModalRef" Visible="@IsAvatarModalOpen" VisibleChanged="OnAvatarVisibleChanged">
        <ModalContent Centered="true">
            <ModalHeader>
                <ModalTitle>ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán</ModalTitle>
                <CloseButton Clicked="CloseAvatarModal" />
            </ModalHeader>
            <ModalBody>
                <div class="text-center">
                    <div class="mb-3">
                        @if (!string.IsNullOrEmpty(avatarPreview))
                        {
                            <img src="@avatarPreview" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                        }
                        else if (!string.IsNullOrEmpty(currentUser?.AvatarUrl))
                        {
                            <img src="@currentUser.AvatarUrl" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="rounded-circle d-flex align-items-center justify-content-center bg-light" style="width: 150px; height: 150px; margin: 0 auto;">
                                <Blazorise.Icons.FontAwesome.Icon Name="IconName.User" Size="IconSize.X3" Class="text-muted" />
                            </div>
                        }
                    </div>
                    <InputFile OnChange="OnFileSelected" accept=".jpg,.jpeg,.png,.gif" class="form-control" />
                    <small class="text-muted">Ch·ªçn ·∫£nh JPG, PNG ho·∫∑c GIF (t·ªëi ƒëa 5MB)</small>
                </div>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="CloseAvatarModal">H·ªßy</Button>
                <Button Color="Color.Primary" @onclick="UploadAvatar" Disabled="@(selectedFile == null)">
                    C·∫≠p nh·∫≠t ·∫£nh (@(selectedFile != null ? "1 file" : "0 files"))
                </Button>
            </ModalFooter>
        </ModalContent>
    </Modal>

    <!-- Modal Chi ti·∫øt b√†i vi·∫øt -->
    @if (selectedPost != null)
    {
        <Modal @ref="postModalRef" Visible="@IsPostModalOpen" VisibleChanged="OnPostVisibleChanged" Size="ModalSize.Large">
            <ModalContent Centered="true" Style="max-height: 80vh;">
                <ModalHeader>
                    <ModalTitle>Chi ti·∫øt b√†i vi·∫øt</ModalTitle>
                    <CloseButton Clicked="ClosePostModal" />
                </ModalHeader>
                <ModalBody Style="display: flex; flex-direction: column; max-height: calc(80vh - 120px);">
                    <div style="flex: 1; overflow-y: auto;">
                        <div class="post-detail mb-4">
                            <h5 class="mb-3 fw-bold">@selectedPost.Title</h5>
                            <small class="text-muted mb-3 d-block">
                                <i class="far fa-calendar"></i> @selectedPost.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                            </small>
                            <div class="post-content mb-3">
                                <div style="white-space: pre-line; line-height: 1.6;">@selectedPost.Content</div>
                            </div>
                            @if (!string.IsNullOrEmpty(selectedPost.ImageUrl))
                            {
                                <div class="post-media mb-3">
                                    <img src="@selectedPost.ImageUrl" alt="Post Image" class="rounded" style="width: 100%; max-height: 400px; object-fit: cover;" />
                                </div>
                            }
                        </div>

                        <div class="comments-section">
                            <h6 class="mb-3">B√¨nh lu·∫≠n (@comments.Count)</h6>
                            @foreach (var comment in comments)
                            {
                                <div class="comment-item d-flex align-items-start mb-3 p-3 bg-light rounded">
                                    <div class="flex-grow-1">
                                        <small class="fw-bold d-block">@comment.AuthorName</small>
                                        <div class="mb-1">@comment.Content</div>
                                        <small class="text-muted">@comment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </ModalBody>
            </ModalContent>
        </Modal>
    }
}

@code {
    private Modal avatarModalRef = default!;
    
    private string activeTab = "info";
    private AuthResponse? currentUser;
    private UserInfo userInfo = new();
    private PasswordChange passwordChange = new PasswordChange();
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isChangingPassword = false;
    private string message = string.Empty;
    private string passwordMessage = string.Empty;
    private bool isSuccess = false;
    private bool isPasswordSuccess = false;
    
    // Avatar upload
    private bool IsAvatarModalOpen = false;
    private IBrowserFile? selectedFile;
    private string avatarPreview = string.Empty;

    // Posts
    private List<Post> userPosts = new();
    private bool isLoadingPosts = false;
    private Post? selectedPost;
    private List<Comment> comments = new();
    private string newCommentContent = string.Empty;
    private bool IsPostModalOpen = false;
    private Modal? postModalRef;

    protected override async Task OnInitializedAsync()
    {
        PageTitleService.Title = "Trang c√° nh√¢n";
        await LoadCurrentUser();
    }

    private async Task LoadCurrentUser()
    {
        try
        {
            // Ch·ªâ load t·ª´ localStorage, kh√¥ng g·ªçi API
            currentUser = await authService.GetCurrentUserAsync();
            
            Console.WriteLine($"üîç LoadCurrentUser: currentUser is null? {currentUser == null}");
            if (currentUser != null)
            {
                Console.WriteLine($"üîç LoadCurrentUser: UserId = {currentUser.UserId}");
                Console.WriteLine($"üîç LoadCurrentUser: Username = {currentUser.Username}");
                Console.WriteLine($"üîç LoadCurrentUser: FullName = {currentUser.FullName}");
                
                // N·∫øu UserId = 0, c·∫ßn fetch t·ª´ backend
                if (currentUser.UserId == 0)
                {
                    Console.WriteLine("‚ö†Ô∏è LoadCurrentUser: UserId is 0, fetching from backend...");
                    await FetchAndUpdateUserId();
                }
            }
            
            if (currentUser == null)
            {
                navigationManager.NavigateTo("/login");
                return;
            }

            // Convert relative avatar URL to full URL if needed
            if (!string.IsNullOrEmpty(currentUser.AvatarUrl))
            {
                Console.WriteLine($"Profile original avatar URL: {currentUser.AvatarUrl}");
                if (currentUser.AvatarUrl.StartsWith("/"))
                {
                    currentUser.AvatarUrl = $"http://localhost:5000{currentUser.AvatarUrl}";
                    Console.WriteLine($"Profile converted avatar URL: {currentUser.AvatarUrl}");
                }
            }

            // Load user info for editing
            userInfo = new UserInfo
            {
                FullName = currentUser.FullName,
                Email = currentUser.Email,
                DateOfBirth = currentUser.DateOfBirth,
                Gender = currentUser.Gender
            };
            
            Console.WriteLine($"Loaded user info: FullName={userInfo.FullName}, Email={userInfo.Email}, DateOfBirth={userInfo.DateOfBirth}, Gender={userInfo.Gender}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user: {ex.Message}");
            navigationManager.NavigateTo("/login");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveProfile()
    {
        // Manual validation
        if (string.IsNullOrWhiteSpace(userInfo.FullName))
        {
            message = "H·ªç v√† t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!";
            isSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(userInfo.Email) || !userInfo.Email.Contains("@"))
        {
            message = "Email kh√¥ng h·ª£p l·ªá!";
            isSuccess = false;
            return;
        }

        isSaving = true;
        message = string.Empty;

        try
        {
            Console.WriteLine("SaveProfile method called - starting update");
            Console.WriteLine($"Sending update request: FullName={userInfo.FullName}, Email={userInfo.Email}, DateOfBirth={userInfo.DateOfBirth}, Gender='{userInfo.Gender}'");
            Console.WriteLine($"Gender type: {userInfo.Gender?.GetType()}, IsNull: {userInfo.Gender == null}, IsEmpty: {string.IsNullOrEmpty(userInfo.Gender)}");
            
            var serviceUserInfo = new UserInfo
            {
                FullName = userInfo.FullName,
                Email = userInfo.Email,
                DateOfBirth = userInfo.DateOfBirth,
                Gender = userInfo.Gender
            };
            Console.WriteLine($"Service UserInfo: FullName={serviceUserInfo.FullName}, Email={serviceUserInfo.Email}, DateOfBirth={serviceUserInfo.DateOfBirth}, Gender='{serviceUserInfo.Gender}'");
            var result = await userService.UpdateProfileAsync(serviceUserInfo);
            Console.WriteLine($"Update result: {result}");
            
            if (result)
            {
                message = "C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!";
                isSuccess = true;
                
                // Update current user info locally after successful database update
                if (currentUser != null)
                {
                    Console.WriteLine($"Before local update: FullName={currentUser.FullName}, Email={currentUser.Email}, DateOfBirth={currentUser.DateOfBirth}, Gender={currentUser.Gender}");
                    
                    // ƒê·∫£m b·∫£o gi·ªØ l·∫°i AccessToken v√† ExpiresAt hi·ªán t·∫°i
                    var currentToken = await authService.GetCurrentUserAsync();
                    if (currentToken?.AccessToken != null)
                    {
                        currentUser.AccessToken = currentToken.AccessToken;
                    }
                    if (currentToken?.ExpiresAt != null)
                    {
                        currentUser.ExpiresAt = currentToken.ExpiresAt;
                    }
                    
                    currentUser.FullName = userInfo.FullName;
                    currentUser.Email = userInfo.Email;
                    currentUser.DateOfBirth = userInfo.DateOfBirth;
                    currentUser.Gender = userInfo.Gender;
                    
                    Console.WriteLine($"After local update: FullName={currentUser.FullName}, Email={currentUser.Email}, DateOfBirth={currentUser.DateOfBirth}, Gender={currentUser.Gender}");
                }
                
                // Update local storage
                await authService.UpdateLocalUserInfo(currentUser);
                Console.WriteLine("Local storage updated");
                
                // Reload from server to confirm database update
                await LoadCurrentUser();
                Console.WriteLine("Reloaded from server to confirm database update");
                
                // Notify MainLayout about user update
                if (currentUser != null)
                {
                    userUpdateService.NotifyUserUpdated(currentUser);
                }
            }
            else
            {
                message = "C·∫≠p nh·∫≠t th·∫•t b·∫°i! Vui l√≤ng th·ª≠ l·∫°i.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"L·ªói: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ChangePassword()
    {
        // Manual validation
        if (string.IsNullOrWhiteSpace(passwordChange.CurrentPassword))
        {
            passwordMessage = "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!";
            isPasswordSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(passwordChange.NewPassword))
        {
            passwordMessage = "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!";
            isPasswordSuccess = false;
            return;
        }

        if (passwordChange.NewPassword.Length < 6)
        {
            passwordMessage = "M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!";
            isPasswordSuccess = false;
            return;
        }

        if (passwordChange.NewPassword != passwordChange.ConfirmPassword)
        {
            passwordMessage = "M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!";
            isPasswordSuccess = false;
            return;
        }

        isChangingPassword = true;
        passwordMessage = string.Empty;

        try
        {
            Console.WriteLine($"Profile ChangePassword: CurrentPassword={!string.IsNullOrEmpty(passwordChange.CurrentPassword)}, NewPassword={!string.IsNullOrEmpty(passwordChange.NewPassword)}, ConfirmPassword={!string.IsNullOrEmpty(passwordChange.ConfirmPassword)}");
            
            var result = await userService.ChangePasswordAsync(passwordChange);
            Console.WriteLine($"Profile ChangePassword result: {result}");
            
            if (result)
            {
                passwordMessage = "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!";
                isPasswordSuccess = true;
                passwordChange = new(); // Reset form
                Console.WriteLine("Password changed successfully, form reset");
            }
            else
            {
                passwordMessage = "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng!";
                isPasswordSuccess = false;
                Console.WriteLine("Password change failed");
            }
        }
        catch (Exception ex)
        {
            passwordMessage = $"L·ªói: {ex.Message}";
            isPasswordSuccess = false;
        }
        finally
        {
            isChangingPassword = false;
        }
    }

    private void ResetForm()
    {
        if (currentUser != null)
        {
            userInfo = new UserInfo
            {
                FullName = currentUser.FullName,
                Email = currentUser.Email,
                DateOfBirth = currentUser.DateOfBirth,
                Gender = currentUser.Gender
            };
        }
        message = string.Empty;
        Console.WriteLine($"Reset form: FullName={userInfo.FullName}, Email={userInfo.Email}, DateOfBirth={userInfo.DateOfBirth}, Gender={userInfo.Gender}");
    }

    private void GoToDashboard()
    {
        navigationManager.NavigateTo("/dashboard");
    }

    private void OpenAvatarModal()
    {
        IsAvatarModalOpen = true;
        selectedFile = null;
        avatarPreview = string.Empty;
    }

    private Task OnAvatarVisibleChanged(bool visible)
    {
        IsAvatarModalOpen = visible;
        return Task.CompletedTask;
    }

    private Task CloseAvatarModal()
    {
        return avatarModalRef.Hide();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        Console.WriteLine("OnFileSelected called!");
        var files = e.GetMultipleFiles();
        Console.WriteLine($"Files count: {files?.Count ?? 0}");
        
        if (files != null && files.Count > 0)
        {
            selectedFile = files[0];
            Console.WriteLine($"File selected: {selectedFile.Name}, Size: {selectedFile.Size} bytes");
            Console.WriteLine($"selectedFile is now: {selectedFile != null}");
            StateHasChanged();
        }
        else
        {
            Console.WriteLine("No files selected or files is null");
        }
    }

    private async Task<bool> UpdateAvatarInDatabase(string avatarUrl)
    {
        try
        {
            using var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri("http://localhost:5000");
            
            if (!await tokenManager.EnsureTokenIsSetAsync(httpClient))
            {
                Console.WriteLine("No valid token available for database update");
                return false;
            }
            
            var updateData = new { AvatarUrl = avatarUrl };
            var json = System.Text.Json.JsonSerializer.Serialize(updateData);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            
            var response = await httpClient.PutAsync("api/users/avatar", content);
            Console.WriteLine($"Database update response: {response.StatusCode}");
            
            return response.IsSuccessStatusCode;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Database update error: {ex.Message}");
            return false;
        }
    }

    private async Task<bool> UploadAvatarToServer(IBrowserFile file)
    {
        try
        {
            Console.WriteLine("Starting upload process...");
            
            using var content = new MultipartFormDataContent();
            Console.WriteLine("Created MultipartFormDataContent");
            
            using var fileContent = new StreamContent(file.OpenReadStream(5 * 1024 * 1024)); // 5MB max
            Console.WriteLine("Created StreamContent");
            
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            Console.WriteLine($"Set content type: {file.ContentType}");
            
            content.Add(fileContent, "file", file.Name);
            Console.WriteLine($"Added file to content: {file.Name}");

            using var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri("http://localhost:5000");
            
            if (!await tokenManager.EnsureTokenIsSetAsync(httpClient))
            {
                Console.WriteLine("No valid token available for upload");
                return false;
            }
            
            Console.WriteLine("Authorization header set via TokenManager");
            
            Console.WriteLine("Sending request to server...");
            var response = await httpClient.PostAsync("api/upload/avatar", content);
            Console.WriteLine($"Response received: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Raw response: {responseContent}");
                
                // Parse JSON response to get URL
                var responseObj = System.Text.Json.JsonSerializer.Deserialize<JsonElement>(responseContent);
                var avatarUrl = responseObj.GetProperty("url").GetString();
                
                // Convert relative URL to full backend URL
                if (avatarUrl != null && avatarUrl.StartsWith("/"))
                {
                    avatarUrl = $"http://localhost:5000{avatarUrl}";
                }
                Console.WriteLine($"Parsed Avatar URL: {avatarUrl}");
                
                // Update database via API (save full URL)
                var updateResult = await UpdateAvatarInDatabase(avatarUrl ?? "");
                if (updateResult)
                {
                    Console.WriteLine("Avatar URL updated in database");
                }
                else
                {
                    Console.WriteLine("Failed to update avatar URL in database");
                }
                
                // Update local user info
                if (currentUser != null)
                {
                    // ƒê·∫£m b·∫£o gi·ªØ l·∫°i AccessToken v√† ExpiresAt hi·ªán t·∫°i
                    var currentToken = await authService.GetCurrentUserAsync();
                    if (currentToken?.AccessToken != null)
                    {
                        currentUser.AccessToken = currentToken.AccessToken;
                    }
                    if (currentToken?.ExpiresAt != null)
                    {
                        currentUser.ExpiresAt = currentToken.ExpiresAt;
                    }
                    
                    currentUser.AvatarUrl = avatarUrl;
                    await authService.UpdateLocalUserInfo(currentUser);
                    Console.WriteLine("Updated local user info");
                    
                    // Notify MainLayout about user update
                    userUpdateService.NotifyUserUpdated(currentUser);
                }
                
                Console.WriteLine($"Avatar uploaded successfully: {avatarUrl}");
                return true;
            }
            
            var errorContent = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Upload failed: {response.StatusCode} - {errorContent}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Upload error: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            return false;
        }
    }

    private async Task LoadUserPosts()
    {
        Console.WriteLine("üî• LoadUserPosts: Starting...");
        
        if (currentUser == null)
        {
            Console.WriteLine("‚ùå LoadUserPosts: currentUser is null!");
            return;
        }
        
        Console.WriteLine($"‚úÖ LoadUserPosts: currentUser exists, UserId = {currentUser.UserId}");
        
        isLoadingPosts = true;
        try
        {
            Console.WriteLine($"üì° LoadUserPosts: Calling postService.GetPostsByUserIdAsync({currentUser.UserId})");
            userPosts = await postService.GetPostsByUserIdAsync(currentUser.UserId);
            Console.WriteLine($"üì¶ LoadUserPosts: Received {userPosts?.Count ?? 0} posts");
            
            // Fix URLs for images
            foreach (var post in userPosts)
            {
                if (!string.IsNullOrEmpty(post.ImageUrl) && !post.ImageUrl.StartsWith("/uploads/"))
                {
                    string fullRelativeUrl = $"/uploads/posts/{post.ImageUrl}";
                    post.ImageUrl = $"http://localhost:5000{fullRelativeUrl}";
                    Console.WriteLine($"üñºÔ∏è LoadUserPosts: Fixed image URL to: {post.ImageUrl}");
                }
                else if (!string.IsNullOrEmpty(post.ImageUrl) && post.ImageUrl.StartsWith("/") && !post.ImageUrl.StartsWith("http"))
                {
                    post.ImageUrl = $"http://localhost:5000{post.ImageUrl}";
                    Console.WriteLine($"üñºÔ∏è LoadUserPosts: Fixed relative URL to: {post.ImageUrl}");
                }
            }
            
            Console.WriteLine($"‚úÖ LoadUserPosts: Successfully loaded {userPosts.Count} posts");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå LoadUserPosts: Error loading user posts: {ex.Message}");
            Console.WriteLine($"‚ùå LoadUserPosts: Stack trace: {ex.StackTrace}");
            Console.WriteLine($"‚ùå LoadUserPosts: Inner exception: {ex.InnerException?.Message}");
        }
        finally
        {
            isLoadingPosts = false;
            Console.WriteLine($"üèÅ LoadUserPosts: Finished, isLoadingPosts = {isLoadingPosts}");
            StateHasChanged(); // Force UI re-render
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        message = string.Empty;
        passwordMessage = string.Empty;
        
        // Load posts when switching to posts tab
        if (tab == "posts")
        {
            LoadUserPosts();
        }
    }

    private async Task OpenPostModal(Post post)
    {
        selectedPost = post;
        comments = await commentService.GetCommentsByPostAsync(post.PostId);
        IsPostModalOpen = true;
    }

    private Task OnPostVisibleChanged(bool visible)
    {
        IsPostModalOpen = visible;
        return Task.CompletedTask;
    }

    private Task ClosePostModal()
    {
        comments.Clear();
        selectedPost = null;
        return Task.CompletedTask;
    }

    private async Task FetchAndUpdateUserId()
    {
        try
        {
            Console.WriteLine("üì° FetchAndUpdateUserId: Calling API /api/users/profile");
            using var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri("http://localhost:5000");
            
            if (!await tokenManager.EnsureTokenIsSetAsync(httpClient))
            {
                Console.WriteLine("‚ùå FetchAndUpdateUserId: No valid token");
                return;
            }
            
            var response = await httpClient.GetAsync("api/users/profile");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"üì° FetchAndUpdateUserId: Response = {content}");
                
                // Parse JSON manually to get userId
                using var doc = System.Text.Json.JsonDocument.Parse(content);
                if (doc.RootElement.TryGetProperty("userId", out var userIdElement))
                {
                    var userId = userIdElement.GetInt32();
                    Console.WriteLine($"‚úÖ FetchAndUpdateUserId: Got userId from JSON = {userId}");
                    
                    if (userId > 0)
                    {
                        currentUser.UserId = userId;
                        await authService.UpdateLocalUserInfo(currentUser);
                        Console.WriteLine($"‚úÖ FetchAndUpdateUserId: Updated localStorage with UserId = {userId}");
                    }
                }
                else
                {
                    Console.WriteLine($"‚ùå FetchAndUpdateUserId: No userId field in response!");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå FetchAndUpdateUserId: Error = {ex.Message}");
        }
    }

    private async Task UploadAvatar()
    {
        if (selectedFile == null) 
        {
            Console.WriteLine("No file selected for upload");
            return;
        }

        try
        {
            Console.WriteLine($"Uploading avatar: {selectedFile.Name}");
            
            var result = await UploadAvatarToServer(selectedFile);
            
            if (result)
            {
                message = "C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!";
                isSuccess = true;
                await CloseAvatarModal();
                await LoadCurrentUser(); // Reload user info
            }
            else
            {
                message = "C·∫≠p nh·∫≠t ·∫£nh th·∫•t b·∫°i!";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"L·ªói: {ex.Message}";
            isSuccess = false;
        }
    }
}



